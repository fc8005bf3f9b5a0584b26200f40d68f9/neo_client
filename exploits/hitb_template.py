#!/usr/bin/python3
import re
import sys
import time
import requests

GAME_URL = "https://ctf.hitb.org/"

def formatServiceURL(service ,url):
    return f"{service}.{url}"

##
# Rellenar antes de ejecutar
#   - XTOKEN: token del equipo (ya puesto)
#   - SERVICE: nombre del servicio a atacar
# El nombre del servicio debe estar en https://ctf.hitb.org/services
##

XTOKEN  = "CHECKSYSTEM_90_7f18c51bc51d81848526f55850ee50d4" # Deberia ser este
SERVICE = "<SERVICE_NAME>"

## 

TARGET_URL = formatServiceURL(SERVICE, sys.argv[1])

def getServiceID():
    while True:
        try:
            r = requests.get(GAME_URL + "services")
            resp_json = r.json()
        except:
            time.sleep(0.5)
            continue
        break

    found_sid = ""
    for sid, sname in resp_json.items():
        if sname == SERVICE:
            found_sid = sid
            break
    
    return found_sid

def getFlagStorages():
    sid = getServiceID()
    try:
        tid = re.search("team([\d]+)\.", TARGET_URL).group(1)
    except AttributeError:
        exit(-1)

    while True:
        try:
            r = requests.get(GAME_URL + "flag_ids?service=" + sid, headers={"X-Team-Token": XTOKEN})
            resp_json = r.json()
        except:
            time.sleep(0.5)
            continue
        break

    return resp_json["flag_ids"][tid]["flag_ids"]

## ESCRIBIR DESDE AQUI (TARGET_URL ser√° el nuevo sys.argv[1]) ##

io = remote(TARGET_URL, 5000)

io.sendline(b"GET %d" % tick)
print(io.recvline().decode(), flush=True)

io.close()
